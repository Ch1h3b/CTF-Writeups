# Malware

Author :@Fa2y

CTF: IngeHack 3.0

Category : Forensics

---

The challenge, as the name indicates, is about a windows malware we need to investigate.
We have two files, the actual Windows executable, and a pcap capture file.

I could go and share my solution of the challenge straight up, but for this challenge, I prefer showing you all the trials and errors I went through before I actually got the flag.

I started by looking at the pcap first, while booting up my Windows machine.
After a quick search on the packets, we can clearly suspect the http requests, which have long hexadecimal strings as session cookies.

[packet](img/packet.png)

Then I went and runned the malware on a windows machine, the program does nothing ( nothing we can see in plain sight ) it is just a black console running.

#### Reverse Engeneering

I opened the exe with ghidra, it was painful to look through the code, as it was written in [nim](https://nim-lang.org)
So, after a considerable amount of time I found a function called `sendKeyStrokes_malware_1646`, it became clear to me that our dear malware was in fact a keylogger.

[ghidra](img/ghidra.png)

The function was still very difficult to figure out, however I found it all it does is xor the registered strokes with a 10-bytes lengthened key before sending them through an http request.
The problem is, the key was not hardcoded, and I could not find out how it was generated with the decompiled code.

### Listening with wireshark

I tried running the malware and listening in wireshark again, however the server which receives the strokes was down, so no session, no keys.

#### Crypto Crib Attack

Knowing the length of the key, and the fact that the sent bytes contained the `IngeHack` text, I tried with my teammate a `known plaintext attack (crib)`.
But we failed anyway, we will see later why.

### Dynamic analysis

I then tried a dynamic analysis with a windows debugger, x64dbg, it was awfully painful too cause there was no cli like gdb, and the gui was not that easy to figure out.

[xdbg](img/xdbg.png)

I actually managed to find the instruction where the xor happened, and successfully set up a breakpoint there, but then ... ??
I really did not know what to do, I could not figure out the assembly code and find where the key was stored, I guess I really need to learn more about dynamic analysis.

### Dumping the process

I tried dumping the memory of the malware process while it was running, and then stringsing it and using the 10 byte length lines to xor the cookies we got from wireshark.
Here is the mistake I made. I assumed the key was a printable string, It was not, and that was really not smart.

### Final attempt

If it were not for someone suggesting [fakenet](https://github.com/mandiant/flare-fakenet-ng), I would not have been able to solve the challenge.
At first fakenet simply did not work, we have no reason why, then with the flareon windows VM, it did, we sent 30 'a's and we got a session cookie like this:
`BF8CDF8EAB9FDBDF7256BF8CDF8EAB9FDBDF7256BF8CDF8EAB9FDBDF7256`

Time to xor back our keys:

```python
lines= ["85A8D09BAF8CE7C77C42ACB6FC8EA995C9CE7254BBB09E8EB89B9ACC7656BA84D088EA9F9ACD7654AC88CACFA491",
"AA889EB48F90CEDB616A7FA0C7CFBA9FC9CD6458AC899E86B9DE1BF77D50BB4CF68EA995",
"7FA68D96B95F1B1FB2967F4C1F4E95CED41F4C437FA58D4E955FF9D223",
"AB891FB06BCD88862404E8DF894E6BA5FFD06752ACB01F4E6B5F1B1FB2967F4C1F4E6B",
"7F4C1F4E6B5F1B1FB2967F4C1F4E6B5F1B1FB2967F4C1FAEB89B9AC77C42",
"FE9ECB9DAFDECED67A44FE84CDCFBE96DF9E755BBF8A1F4E6B5F1B1FB296",
"7F4C1F4E6B41E1FB7D43BB9FE34E839AD19E6745A784CACFAB90DE9E6752B2819E82AFDE"]

a_xored=bytes.fromhex("BF8CDF8EAB9FDBDF7256BF8CDF8EAB9FDBDF7256BF8CDF8EAB9FDBDF7256")
aa = bytes.fromhex("616161616161616161616161616161616161616161616161616161616161") 
from pwn import xor

key = xor(a_xored, aa)[:10]

print(key)	

for l in lines:
	b= bytes.fromhex(l)
	print(xor(b, key))
```

Flag: `IngeHack{K3ys_0n_t1H3a1cl0_32873627}`

So what oyr mistake was was actually assuming that `IngeHack` was in the text, and it was not, there was the hex ‘a1’ between Inge and Hack which I am assuming is the reference to the shift key.
A lot of failed attempts missed because of this mistake! x)

I really learned a lot in this challenge, thanks to @Fa2y for the creativity, and I had a lot of fun solving it.
